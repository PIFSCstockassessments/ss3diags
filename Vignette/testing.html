<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Meg Oshima" />


<title>ss3diags Unit Testing</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">ss3diags Unit Testing</h1>
<h4 class="author">Meg Oshima</h4>
<h4 class="date">9/20/2021</h4>


<div id="TOC">
<ul>
<li><a href="#basics-of-unit-testing">Basics of Unit Testing</a></li>
<li><a href="#workflow">Workflow</a>
<ul>
<li><a href="#first-time">First Time</a></li>
<li><a href="#routine-workflow">Routine Workflow</a></li>
<li><a href="#test-file-structure">Test file structure</a></li>
</ul></li>
<li><a href="#ss3diags-tests">ss3diags Tests</a>
<ul>
<li><a href="#example-code">Example code</a>
<ul>
<li><a href="#ssrunstest-for-cpue-data">SSrunstest for CPUE
data</a></li>
<li><a href="#ssrunstest-for-length-comp-data">SSrunstest for Length
Comp data</a></li>
<li><a href="#ssplotrunstest">SSplotRunstest</a></li>
</ul></li>
</ul></li>
<li><a href="#continuous-integration-with-github-actions">Continuous
Integration with Github Actions</a></li>
<li><a href="#troubleshooting-and-issues">Troubleshooting and
Issues</a></li>
<li><a href="#questions">Questions</a></li>
</ul>
</div>

<div id="basics-of-unit-testing" class="section level2">
<h2>Basics of Unit Testing</h2>
<p>Unit testing verifies that a function is precise and correct when
returning the expected value of <em>y</em> for a specific value of
<em>x</em> in the function. It is an automated, formal testing of code
that is beneficial because there are fewer bugs in your code, better
code structure (less redundancy, and smaller separate functions vs fewer
complicated ones), and more robust code (less likely to break with big
changes).</p>
</div>
<div id="workflow" class="section level2">
<h2>Workflow</h2>
<div id="first-time" class="section level3">
<h3>First Time</h3>
<p>When first creating test files, use the <code>usethis</code> package
and run the function <code>usethis::use_testthat()</code> to:</p>
<ul>
<li>create a tests/testthat directory<br />
</li>
<li>add <code>testthat</code> to the <code>Suggests</code> field in the
<code>DESCRIPTION</code> of the package<br />
</li>
<li>create a file <code>tests/testthat.R</code> that automatically runs
all tests when you run <code>R CMD check</code>.</li>
</ul>
</div>
<div id="routine-workflow" class="section level3">
<h3>Routine Workflow</h3>
<p>After the first time, the workflow should look something like:</p>
<ul>
<li>use <code>testthat::use_test(&quot;name-of-function&quot;)</code> to create a
test template file in the correct directory. It will be named
<code>test-name-of-function.R</code><br />
</li>
<li>follow the template structure and modify the code as needed to test
functions<br />
</li>
<li>one script can be used for multiple functions, but don’t want to
make the files too large (consider best ways to organize the functions
within scripts)<br />
</li>
<li>need to know the function you want to test and what the expected
outcome should be<br />
</li>
<li>use
<code>testthat::test_file(&quot;./tests/testthat/test-name-of-function.R&quot;)</code>
to run the single file to see if the test passed or failed<br />
</li>
<li>as you add or modify code, continue testing<br />
</li>
<li>once everything is good, use <code>devtools::test()</code> to test
the entire package and ensure everything passes</li>
</ul>
</div>
<div id="test-file-structure" class="section level3">
<h3>Test file structure</h3>
<p>Tests should be organized hierarchically: <em>expectations</em> –&gt;
<em>tests</em> –&gt; <em>test.R files</em></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## library any other packages you may need</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="do">## include any general code you may need, ie setting environment path</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Generalized structure of test functions </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;description of test&quot;</span>, {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># an expect statement with the function being tested and the expected outcome</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>((<span class="dv">2</span><span class="sc">+</span><span class="dv">2</span>), <span class="dv">4</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>((<span class="dv">3</span><span class="sc">+</span><span class="dv">2</span>), <span class="dv">4</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
</div>
</div>
<div id="ss3diags-tests" class="section level2">
<h2>ss3diags Tests</h2>
<p>To test the functions in ss3daigs I am creating individual scripts
for each function and testing the outputs of those functions for Pacific
Hake, Shortfin Mako, and GOB Herring. Test scripts include:</p>
<ul class="task-list">
<li><input type="checkbox" disabled checked></input>
runs-test (SSrunstest, SSplotRunstest)<ul class="task-list">
<li><input type="checkbox" disabled checked></input>
cpue (mako, hake, herring)</li>
<li><input type="checkbox" disabled checked></input>
length (mako)<br />
</li>
<li><input type="checkbox" disabled checked></input>
age (hake, herring)</li>
</ul></li>
<li><input type="checkbox" disabled></input>
residuals (SSplotJABBAres)</li>
<li><input type="checkbox" disabled></input>
retrospective and forecast bias (SSplotRetro, SShcbias)</li>
<li><input type="checkbox" disabled></input>
hindcast cross-validataion and prediction skills (SSretroComps,
SSplotHCxval, SSmase)</li>
<li><input type="checkbox" disabled></input>
model uncertainty (SSplotEnsemble, SSdiagsMCMC, SSplotKobe)</li>
<li><input type="checkbox" disabled></input>
utils (SSsettingsBratioF)</li>
</ul>
<div id="example-code" class="section level3">
<h3>Example code</h3>
<div id="ssrunstest-for-cpue-data" class="section level4">
<h4>SSrunstest for CPUE data</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;runs test works with shortfin mako&quot;</span>, {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Load in data</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="fu">file.path</span>(test_example_path, <span class="st">&quot;natl.sma.rdata&quot;</span>))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## pull out cpue obs and est values for the first fleet</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  test.resids <span class="ot">&lt;-</span> ss3sma<span class="sc">$</span>cpue[<span class="fu">which</span>(ss3sma<span class="sc">$</span>cpue<span class="sc">$</span>Fleet_name <span class="sc">==</span> <span class="st">&quot;CPUE_1&quot;</span>), <span class="fu">c</span>(<span class="st">&quot;Fleet_name&quot;</span>, <span class="st">&quot;Yr&quot;</span>, <span class="st">&quot;Obs&quot;</span>, <span class="st">&quot;Exp&quot;</span>)]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate residuals </span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  test.resids<span class="sc">$</span>residuals <span class="ot">=</span> <span class="fu">log</span>(test.resids<span class="sc">$</span>Obs) <span class="sc">-</span> <span class="fu">log</span>(test.resids<span class="sc">$</span>Exp)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate lower and upper confidence levels (code copied from SSrunstest script)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  mr <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">diff</span>(test.resids<span class="sc">$</span>residuals <span class="sc">-</span> mu))</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  amr <span class="ot">&lt;-</span> <span class="fu">mean</span>(mr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  ulmr <span class="ot">&lt;-</span> <span class="fl">3.267</span> <span class="sc">*</span> amr</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  mr  <span class="ot">&lt;-</span> mr[mr <span class="sc">&lt;</span> ulmr]</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  amr <span class="ot">&lt;-</span> <span class="fu">mean</span>(mr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  stdev <span class="ot">&lt;-</span> amr <span class="sc">/</span> <span class="fl">1.128</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  lcl <span class="ot">&lt;-</span> mu <span class="sc">-</span> <span class="dv">3</span> <span class="sc">*</span> stdev</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  ucl <span class="ot">&lt;-</span> mu <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> stdev</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## use randtests:: runs.test to calculate p-value</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  runstest <span class="ot">&lt;-</span> randtests<span class="sc">::</span><span class="fu">runs.test</span>(test.resids<span class="sc">$</span>residuals, </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> <span class="dv">0</span>, </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">alternative =</span> <span class="st">&quot;left.sided&quot;</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  test.p <span class="ot">&lt;-</span> <span class="fu">round</span>(runstest<span class="sc">$</span>p.value, <span class="dv">3</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="do">## for cpue</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  n.cpue <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(ss3sma<span class="sc">$</span>cpue<span class="sc">$</span>Fleet))</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  run_cpue <span class="ot">&lt;-</span> <span class="fu">SSrunstest</span>(ss3sma, <span class="at">quants =</span> <span class="st">&quot;cpue&quot;</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="do">## testing structure of dataframe</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_match</span>(run_cpue<span class="sc">$</span>Index[<span class="dv">1</span>], <span class="st">&quot;CPUE_1&quot;</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">nrow</span>(run_cpue), n.cpue)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="do">## testing values in the first row</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(run_cpue<span class="sc">$</span>runs.p[<span class="dv">1</span>], test.p)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(run_cpue<span class="sc">$</span>sigma3.lo[<span class="dv">1</span>], lcl)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(run_cpue<span class="sc">$</span>sigma3.hi[<span class="dv">1</span>], ucl)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  <span class="do">## checking structure of dataframe if cpue index specified</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  run_cpue <span class="ot">&lt;-</span> <span class="fu">SSrunstest</span>(ss3sma, <span class="at">quants =</span> <span class="st">&quot;cpue&quot;</span>, <span class="at">indexselect =</span> <span class="dv">4</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_match</span>(run_cpue<span class="sc">$</span>Index, <span class="st">&quot;CPUE_4&quot;</span>)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  run_cpue <span class="ot">&lt;-</span> <span class="fu">SSrunstest</span>(ss3sma, <span class="at">quants =</span> <span class="st">&quot;cpue&quot;</span>, <span class="at">indexselect =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(run_cpue<span class="sc">$</span>Index, <span class="fu">c</span>(<span class="st">&quot;CPUE_3&quot;</span>, <span class="st">&quot;CPUE_4&quot;</span>, <span class="st">&quot;CPUE_5&quot;</span>))</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p><br></p>
</div>
<div id="ssrunstest-for-length-comp-data" class="section level4">
<h4>SSrunstest for Length Comp data</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## for length comp</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="do">## get length comp data for first fishery</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  len.test.resids <span class="ot">&lt;-</span> ss3sma<span class="sc">$</span>lendbase[<span class="fu">which</span>(ss3sma<span class="sc">$</span>lendbase<span class="sc">$</span>Fleet <span class="sc">==</span> <span class="dv">1</span>),]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="do">## create index column</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  len.test.resids<span class="sc">$</span>indx <span class="ot">=</span> <span class="fu">paste</span>(len.test.resids<span class="sc">$</span>Fleet, len.test.resids<span class="sc">$</span>Yr, len.test.resids<span class="sc">$</span>Seas)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  uind <span class="ot">&lt;-</span> <span class="fu">unique</span>(len.test.resids<span class="sc">$</span>indx)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  pldat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="fu">length</span>(uind),<span class="dv">13</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dimnames=</span><span class="fu">list</span>(uind,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">c</span>(<span class="st">&#39;Obsmn&#39;</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;Obslo&#39;</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;Obshi&#39;</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;semn&#39;</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;Expmn&#39;</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;Like&#39;</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;Std.res&#39;</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;ObsloAdj&#39;</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;ObshiAdj&#39;</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;Fleet&#39;</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;Yr&#39;</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;Time&#39;</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;Seas&#39;</span>)))</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create subdataframes and then calculate variables (copied from SSrunstest script)</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(uind)){  </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    subdbase <span class="ot">&lt;-</span> len.test.resids[<span class="fu">which</span>(len.test.resids<span class="sc">$</span>indx <span class="sc">==</span> uind[i]),]</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(subdbase<span class="sc">$</span>Nsamp_adj)) subdbase<span class="sc">$</span>Nsamp_adj <span class="ot">=</span> subdbase<span class="sc">$</span>N </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    xvar <span class="ot">&lt;-</span> subdbase<span class="sc">$</span>Bin</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;Obsmn&#39;</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(subdbase<span class="sc">$</span>Obs<span class="sc">*</span>xvar)<span class="sc">/</span><span class="fu">sum</span>(subdbase<span class="sc">$</span>Obs)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;Expmn&#39;</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(subdbase<span class="sc">$</span>Exp<span class="sc">*</span>xvar)<span class="sc">/</span><span class="fu">sum</span>(subdbase<span class="sc">$</span>Exp)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;semn&#39;</span>] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((<span class="fu">sum</span>(subdbase<span class="sc">$</span>Exp<span class="sc">*</span>xvar<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="fu">sum</span>(subdbase<span class="sc">$</span>Exp)<span class="sc">-</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>                               pldat[i,<span class="st">&#39;Expmn&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="fu">mean</span>(subdbase<span class="sc">$</span>Nsamp_adj))</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;Obslo&#39;</span>] <span class="ot">&lt;-</span> pldat[i,<span class="st">&#39;Obsmn&#39;</span>]<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>pldat[i,<span class="st">&#39;semn&#39;</span>]</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;Obshi&#39;</span>] <span class="ot">&lt;-</span> pldat[i,<span class="st">&#39;Obsmn&#39;</span>]<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>pldat[i,<span class="st">&#39;semn&#39;</span>]</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;Std.res&#39;</span>] <span class="ot">&lt;-</span> (pldat[i,<span class="st">&#39;Obsmn&#39;</span>]<span class="sc">-</span>pldat[i,<span class="st">&#39;Expmn&#39;</span>])<span class="sc">/</span>pldat[i,<span class="st">&#39;semn&#39;</span>]</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;Fleet&#39;</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(subdbase<span class="sc">$</span>Fleet)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;Yr&#39;</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(subdbase<span class="sc">$</span>Yr) </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;Time&#39;</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(subdbase<span class="sc">$</span>Time)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;Seas&#39;</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(subdbase<span class="sc">$</span>Seas)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;Like&#39;</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(subdbase<span class="sc">$</span>Like)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  Nmult <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">var</span>(pldat[,<span class="st">&#39;Std.res&#39;</span>],<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(uind)){</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;ObsloAdj&#39;</span>] <span class="ot">&lt;-</span> pldat[i,<span class="st">&#39;Obsmn&#39;</span>]<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>pldat[i,<span class="st">&#39;semn&#39;</span>]<span class="sc">/</span><span class="fu">sqrt</span>(Nmult)</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    pldat[i,<span class="st">&#39;ObshiAdj&#39;</span>] <span class="ot">&lt;-</span> pldat[i,<span class="st">&#39;Obsmn&#39;</span>]<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>pldat[i,<span class="st">&#39;semn&#39;</span>]<span class="sc">/</span><span class="fu">sqrt</span>(Nmult)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>  pldat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(pldat)</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>  yrs <span class="ot">&lt;-</span> pldat<span class="sc">$</span>Yr</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create dataframe used for running the runs test</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  runs_dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fleet=</span>pldat<span class="sc">$</span>Fleet,</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Fleet_name=</span>ss3sma<span class="sc">$</span>FleetNames[pldat<span class="sc">$</span>Fleet],</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Yr=</span>yrs,</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Time=</span>pldat<span class="sc">$</span>Time,</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Seas=</span>pldat<span class="sc">$</span>Seas,</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Obs=</span>pldat<span class="sc">$</span>Obsmn,</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Exp=</span>pldat<span class="sc">$</span>Expmn,</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>                         <span class="at">SE=</span>((pldat<span class="sc">$</span>Obsmn<span class="sc">-</span>pldat<span class="sc">$</span>ObsloAdj)<span class="sc">/</span><span class="fl">1.96</span>)<span class="sc">/</span>pldat<span class="sc">$</span>ObsloAdj,</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Like=</span>pldat<span class="sc">$</span>Like)</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add column for residuals</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  <span class="do">## run similar tests as for CPUE, checking structure and values for correctness</span></span></code></pre></div>
<p><br></p>
</div>
<div id="ssplotrunstest" class="section level4">
<h4>SSplotRunstest</h4>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## SMA</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;snapshot of sma_cpue&quot;</span>, {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## save plot as a png in a temporary directory (path)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SSplotRunstest</span>(ss3sma, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">png =</span> <span class="cn">TRUE</span>, </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">print =</span> T, </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">subplots =</span> <span class="st">&quot;cpue&quot;</span>, </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">indexselect =</span> <span class="dv">3</span>, </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">plotdir =</span> path, </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">filenameprefix =</span> <span class="st">&quot;sma_&quot;</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## check that there is a file with the expected name in the temporary directory</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(<span class="fu">file.exists</span>(<span class="fu">file.path</span>(path, <span class="st">&quot;sma_residruns_CPUE_3.png&quot;</span>)))</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
</div>
</div>
</div>
<div id="continuous-integration-with-github-actions" class="section level2">
<h2>Continuous Integration with Github Actions</h2>
<p>Workflows can be setup to automate certain processes when a specifed
event occurs. Events could include things such as an issue being opened,
a push to the repo, or a pull request. When one of these events happens,
it triggers one or more actions automatically. An example workflow would
be: commit new code –&gt; run test automatically –&gt; build new package
–&gt; deploy new version of package.</p>
<p>Currently, I set up the workflow for the first two steps; every time
a new commit is made to the repo, it runs the R CMD check function and
checks all of the test.R scripts. The workflow file is stored in
<code>.github/workflows/R-CMD-check.yml</code>.</p>
</div>
<div id="troubleshooting-and-issues" class="section level2">
<h2>Troubleshooting and Issues</h2>
<table>
<colgroup>
<col width="46%" />
<col width="53%" />
</colgroup>
<thead>
<tr class="header">
<th>Problem</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Opening .Rdata files from package folder</td>
<td>Created a new sub-folder <code>inst</code> and <code>extdata</code>
and copied .Rdata files into there then used
<code>system.file(&quot;extdata&quot;, package = &quot;ss3diags&quot;)</code> as the testing
path.</td>
</tr>
<tr class="even">
<td>For checking plots, need to be able to save the plot as an object
but right now it can’t, only the runs test table is returned as an
object by the function.</td>
<td>Currently just saving the plot as a .png and checking to see if the
file exists. Maybe consider adding the plot in the return() portion of
the function so that the object can be saved as well as the table in the
environment.</td>
</tr>
</tbody>
</table>
</div>
<div id="questions" class="section level2">
<h2>Questions</h2>
<ul>
<li>Do I only need to test structure of outputs (e.g. nrow = 4, ncol =
6, class, etc.)?<br />
</li>
<li>Should I use the actual numbers from output or calculate it so that
if the rdata files change, the numbers will change with it? Using actual
numbers will tell you if something is wrong with the file/code you
currently have but if the models are going to be updated at some point,
it is easier to write the code so that it is flexible.</li>
</ul>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
